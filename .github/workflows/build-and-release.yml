name: Build and Release

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["**"]

permissions:
  contents: write
  packages: write

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}

    strategy:
      matrix:
        target:
          - aarch64-linux-android
          - x86_64-linux-android
          - armv7a-linux-androideabi

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: Clone simplybs
        run: git clone https://github.com/MrCyjaneK/simplybs

      - name: Build ${{ matrix.target }}
        run: timeout 5h ./build.sh ${{ matrix.target }} || true

      - name: Upload Android artifacts individually
        run: |
          GOOS=$(go env GOOS)
          GOARCH=$(go env GOARCH)
          BUILDER="${GOOS}_${GOARCH}"
          RELEASE_NAME="${BUILDER}-${{ matrix.target }}-cache"
          ART_DIR="simplybs/.buildlib/${BUILDER}/built/${{ matrix.target }}"

          mkdir -p "$ART_DIR"

          # Determine .so location
          if [[ "${{ matrix.target }}" == "aarch64-linux-android" ]]; then
            cp android/src/main/jniLibs/arm64-v8a/libtorch.so "$ART_DIR/"
          elif [[ "${{ matrix.target }}" == "x86_64-linux-android" ]]; then
            cp android/src/main/jniLibs/x86_64/libtorch.so "$ART_DIR/"
          elif [[ "${{ matrix.target }}" == "armv7a-linux-androideabi" ]]; then
            cp android/src/main/jniLibs/armeabi-v7a/libtorch.so "$ART_DIR/"
          fi

          # Create release if missing
          if ! gh release view "$RELEASE_NAME" >/dev/null 2>&1; then
            gh release create "$RELEASE_NAME" --prerelease --notes "Android cache for $RELEASE_NAME"
          fi

          # Upload files individually
          find "$ART_DIR" -type f | while read -r FILE; do
            BASENAME=$(basename "$FILE")
            if ! gh release view "$RELEASE_NAME" --json assets -q ".assets[].name" | grep -qx "$BASENAME"; then
              gh release upload "$RELEASE_NAME" "$FILE"
            fi
          done

  build-apple-darwin:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    strategy:
      matrix:
        target:
          - aarch64-apple-darwin
          - x86_64-apple-darwin

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: Install build dependencies
        run: sudo apt update && sudo apt install -y clang llvm gcc g++

      - name: Clone simplybs
        run: git clone https://github.com/MrCyjaneK/simplybs

      - name: Build ${{ matrix.target }}
        run: timeout 5h env SKIP_XC=yes SIMPLYBS_DOWNLOAD_FIRST=yes ./build.sh ${{ matrix.target }} || true

      - name: Upload Apple artifacts individually
        run: |
          GOOS=$(go env GOOS)
          GOARCH=$(go env GOARCH)
          BUILDER="${GOOS}_${GOARCH}"
          RELEASE_NAME="${BUILDER}-${{ matrix.target }}-cache"
          ART_DIR="simplybs/.buildlib/${BUILDER}/built/${{ matrix.target }}"

          mkdir -p "$ART_DIR"
          cp simplybs/.buildlib/env/${{ matrix.target }}/lib/libtorch.dylib "$ART_DIR/"

          if ! gh release view "$RELEASE_NAME" >/dev/null 2>&1; then
            gh release create "$RELEASE_NAME" --prerelease --notes "Apple cache for $RELEASE_NAME"
          fi

          find "$ART_DIR" -type f | while read -r FILE; do
            BASENAME=$(basename "$FILE")
            if ! gh release view "$RELEASE_NAME" --json assets -q ".assets[].name" | grep -qx "$BASENAME"; then
              gh release upload "$RELEASE_NAME" "$FILE"
            fi
          done

  build-apple-ios:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - aarch64-apple-ios
          - aarch64-apple-ios-simulator
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: Clone simplybs
        run: git clone https://github.com/MrCyjaneK/simplybs

      - name: Build ${{ matrix.target }}
        run: timeout 5h ./build.sh ${{ matrix.target }} || true

      - name: Upload iOS artifacts individually
        run: |
          GOOS=$(go env GOOS)
          GOARCH=$(go env GOARCH)
          BUILDER="${GOOS}_${GOARCH}"
          RELEASE_NAME="${BUILDER}-${{ matrix.target }}-cache"
          ART_DIR="simplybs/.buildlib/${BUILDER}/built/${{ matrix.target }}"

          mkdir -p "$ART_DIR"
          cp simplybs/.buildlib/env/${{ matrix.target }}/lib/libtorch.dylib "$ART_DIR/"

          if ! gh release view "$RELEASE_NAME" >/dev/null 2>&1; then
            gh release create "$RELEASE_NAME" --prerelease --notes "iOS cache for $RELEASE_NAME"
          fi

          find "$ART_DIR" -type f | while read -r FILE; do
            BASENAME=$(basename "$FILE")
            if ! gh release view "$RELEASE_NAME" --json assets -q ".assets[].name" | grep -qx "$BASENAME"; then
              gh release upload "$RELEASE_NAME" "$FILE"
            fi
          done

  create-apple-frameworks:
    runs-on: ubuntu-latest
    needs: [build-apple-darwin, build-apple-ios]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: Restore Apple build artifacts
        run: |
          builder=$(go env GOOS)_$(go env GOARCH)
          mkdir -p simplybs/.buildlib/$builder/built
          for TARGET in aarch64-apple-darwin x86_64-apple-darwin aarch64-apple-ios aarch64-apple-ios-simulator; do
            RELEASE_NAME="$builder-${TARGET}-cache"
            if gh release view "$RELEASE_NAME" >/dev/null 2>&1; then
              gh release view "$RELEASE_NAME" --json assets -q '.assets[].name' | while read FILE; do
                gh release download "$RELEASE_NAME" -p "$FILE" -D "simplybs/.buildlib/$builder/built/$TARGET/"
              done
            fi
          done

      - name: Create XCFrameworks
        run: ./create-xcframework.sh

      - name: Upload Apple frameworks
        uses: actions/upload-artifact@v4
        with:
          name: apple-frameworks
          path: |
            ios/LibTorch.xcframework/
            macos/LibTorch.xcframework/
          retention-days: 1
  assemble-and-release:
    runs-on: ubuntu-latest
    needs: [build-android, create-apple-frameworks]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Restore Android artifacts
        run: |
          mkdir -p simplybs/.buildlib/linux_amd64/built
          for TARGET in aarch64-linux-android x86_64-linux-android armv7a-linux-androideabi; do
            RELEASE_NAME="linux_amd64-${TARGET}-cache"
            if gh release view "$RELEASE_NAME" >/dev/null 2>&1; then
              gh release view "$RELEASE_NAME" --json assets -q '.assets[].name' | while read FILE; do
                gh release download "$RELEASE_NAME" -p "$FILE" -D "simplybs/.buildlib/linux_amd64/built/$TARGET/"
              done
            fi
          done

      - name: Restore Apple frameworks
        uses: actions/download-artifact@v4
        with:
          name: apple-frameworks
          path: apple-artifacts/

      - name: Assemble final package
        run: |
          cp simplybs/.buildlib/linux_amd64/built/aarch64-linux-android/libtorch.so android/src/main/jniLibs/arm64-v8a/
          cp simplybs/.buildlib/linux_amd64/built/x86_64-linux-android/libtorch.so android/src/main/jniLibs/x86_64/
          cp simplybs/.buildlib/linux_amd64/built/armv7a-linux-androideabi/libtorch.so android/src/main/jniLibs/armeabi-v7a/

          cp -r apple-artifacts/ios/LibTorch.xcframework ios/
          cp -r apple-artifacts/macos/LibTorch.xcframework macos/

          rm -rf apple-artifacts

      - name: Get version tag
        id: get_version
        run: |
          git fetch --tags
          LATEST_TAG=$(git tag -l "v*.*.*" | sort -V | tail -n1)
          if [ -z "$LATEST_TAG" ]; then
            VERSION=v0.0.1
          else
            COMMIT_COUNT=$(git rev-list ${LATEST_TAG}..HEAD --count)
            if [ "$COMMIT_COUNT" = "0" ]; then
              VERSION="$LATEST_TAG"
            else
              IFS='.' read -r MAJOR MINOR PATCH <<< "${LATEST_TAG#v}"
              PATCH=$((PATCH + COMMIT_COUNT))
              VERSION="v${MAJOR}.${MINOR}.${PATCH}"
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          if git describe --exact-match --tags HEAD >/dev/null 2>&1; then
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "release_name=Release $VERSION" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "release_name=Pre-release $VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Create Release Tarball
        run: |
          tar -czf ../torch_dart-${{ steps.get_version.outputs.version }}.tar.gz --exclude='.git' .
          mv ../torch_dart-${{ steps.get_version.outputs.version }}.tar.gz .

      - name: Publish GitHub Release
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: ${{ steps.get_version.outputs.release_name }}
          prerelease: ${{ steps.get_version.outputs.is_prerelease }}
          files: torch_dart-${{ steps.get_version.outputs.version }}.tar.gz
          generate_release_notes: true
          body: |
            ## Built Targets

            ### Android
            - aarch64-linux-android → arm64-v8a/libtorch.so
            - x86_64-linux-android → x86_64/libtorch.so
            - armv7a-linux-androideabi → armeabi-v7a/libtorch.so

            ### Apple
            - iOS XCFramework (device + simulator)
            - macOS XCFramework (universal arm64 + x86_64)
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
